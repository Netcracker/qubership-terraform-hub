# .github/workflows/process-allure-results.yml
name: Process Allure Results and Generate Reports

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  # Also allow manual trigger
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYY-MM-DD)'
        required: false
        default: ''
      source_bucket:
        description: 'Source S3 bucket'
        required: false
        default: 'consul-test'
      destination_bucket:
        description: 'Temporary destination bucket'
        required: false
        default: 'qstp-consul-allure'

env:
  SOURCE_BUCKET: 'consul-test'
  DESTINATION_BUCKET: 'qstp-consul-allure'
  AWS_REGION: 'us-east-1'
  ALLURE_URL: 'https://k8s-qstpallu-allurein-413be1b9d5-1630657851.us-east-1.elb.amazonaws.com/allure-api/allure-docker-service'
  PROJECT_ID: 'consul-test'

jobs:
  process-and-generate-reports:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install boto3 requests

      - name: Run processing script
        env:
          TARGET_DATE: ${{ github.event.inputs.target_date || '' }}
          SOURCE_BUCKET: ${{ github.event.inputs.source_bucket || env.SOURCE_BUCKET }}
          DEST_BUCKET: ${{ github.event.inputs.destination_bucket || env.DESTINATION_BUCKET }}
          AWS_REGION: ${{ env.AWS_REGION }}
          ALLURE_URL: ${{ env.ALLURE_URL }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          ALLURE_USERNAME: ${{ secrets.ALLURE_USERNAME }}
          ALLURE_PASSWORD: ${{ secrets.ALLURE_PASSWORD }}
        run: |          
          # Run the script
          python allure-report/process_s3_folders.py
          
          # Check if reports were generated
          if [ -f "${{ github.workspace }}/allure_reports_list.txt" ]; then
            echo "Reports were generated successfully"
            cat "${{ github.workspace }}/allure_reports_list.txt"
          else
            echo "No reports were generated"
          fi

      - name: Upload Allure Reports as Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: allure-reports
          path: |
            ${{ github.workspace }}/allure_reports_list.txt
            /tmp/allure_reports_*/
          retention-days: 30

      - name: Create Processing Summary
        if: always()
        run: |
          echo "## Allure Results Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** ${{ github.event.inputs.target_date || 'Today' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source Bucket:** ${{ env.SOURCE_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "**Temporary Bucket:** ${{ env.DESTINATION_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "**Allure Project:** ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "${{ github.workspace }}/allure_reports_list.txt" ]; then
            echo "### Generated Reports" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r line; do
              echo "- $(basename "$line")" >> $GITHUB_STEP_SUMMARY
            done < "${{ github.workspace }}/allure_reports_list.txt"
          else
            echo "No reports were generated during this run." >> $GITHUB_STEP_SUMMARY
          fi