name: GitHub Runner SSH Debug

on:
  workflow_dispatch:
    inputs:
      public-key:
        description: "SSH Public Key, to put in authorized_keys"
        required: true
      gateway-ip:
        description: "IP of gateway to connect to"
        required: true
      port:
        description: "SSH Port (default: 22)"
        required: false
        default: "22"

jobs:
  debug-ssh:
    runs-on: ubuntu-latest

    steps:
      - name: Install requirements
        shell: bash
        id: download
        run: |            
            sudo apt update -qqqy
            sudo apt install -qqqy openssh-server tmux

      - name: Setup SSHD
        shell: bash
        id: setup
        env:
          GATEWAY_IP: ${{ github.event.inputs.gateway-ip }}
          PORT: ${{ github.event.inputs.port }}
        run: |
          sudo systemctl enable ssh
          sudo ufw allow from ${GATEWAY_IP} to any port ${PORT}
          sudo ufw --force enable
          if [ -z "$(find /etc/ssh/ -name 'ssh_host_*' -type f)" ]; then 
            DEBIAN_FRONTEND=noninteractive sudo -E dpkg-reconfigure openssh-server
          fi
          echo "PasswordAuthentication no" | sudo tee -a /etc/ssh/sshd_config
          echo "ChallengeResponseAuthentication no" | sudo tee -a /etc/ssh/sshd_config
          sudo sed -i "s/.*PasswordAuthentication.*/PasswordAuthentication no/g" /etc/ssh/sshd_config
          sudo sed -i "s/.*Port.*/Port ${PORT}/g" /etc/ssh/sshd_config
          sudo systemctl daemon-reload
          sudo systemctl restart ssh

      - name: Install authorized key
        shell: bash
        id: keys
        env:
          SSH_PUBLIC_KEY: ${{ github.event.inputs.public-key }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PUBLIC_KEY}" > ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys

      - name: How to connect
        shell: bash
        id: how-to-connect
        env:
          PORT: ${{ github.event.inputs.port }}
        run: echo "from gateway server run ssh -p ${PORT} $(whoami)@localhost"

      - name: Open reverse ssh
        shell: bash
        id: reverse-ssh
        env:
          GATEWAY_PRIVATE_KEY: ${{ secrets.RUNNER_DEBUG_SSH_PRIVATE_KEY }}
          GATEWAY_IP: ${{ github.event.inputs.gateway-ip }}
          GATEWAY_USER: root
          MAX_LIFE_TIME: 3600
          PORT: 2222
        run: |
          echo "$GATEWAY_PRIVATE_KEY" > temp_key.pem
          chmod 400 temp_key.pem
          
          # Create unblock script
          sudo tee /usr/local/bin/unblock > /dev/null << 'EOF'
          #!/bin/bash
          tmux kill-session
          EOF
          sudo chmod +x /usr/local/bin/unblock
          
          # Create motd
          sudo tee /etc/motd > /dev/null << 'EOF'
          A tmux session is running in the background, you can attach with 
          "tmux attach". To stop this host, run "unblock" or "tmux kill-session".
          EOF
    
          # Start tmux session
          tmux new-session -d -s debug
          
          # Start reverse SSH tunnel in background
          ssh -o StrictHostKeyChecking=no -i temp_key.pem -R 22:localhost:${PORT} ${GATEWAY_USER}@${GATEWAY_IP} "sleep ${MAX_LIFE_TIME}" &
          SSH_PID=$!
          
          # Wait for tmux session to be closed
          tmux wait-for channel
          
          # Cleanup
          kill $SSH_PID 2>/dev/null || true
          rm -f temp_key.pem
