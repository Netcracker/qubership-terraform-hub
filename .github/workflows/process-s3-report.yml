name: Process Consul Test Results

on:
  workflow_dispatch:
    inputs:
      s3_directory:
        description: 'S3 Directory Path (e.g., Result/consul/2025-12-10/00-42-50/)'
        required: true
        default: 'Result/consul/2025-12-10/00-42-50'
        type: string
  repository_dispatch:
    types: [s3-new-consul-directory]

env:
  S3_BUCKET: qstp-consul
  OUTPUT_DIR: ./allure-report
  SINGLE_FILE_DIR: ./allure-single-file
  SOURCE_DIR: ./allure-results

jobs:
  generate-allure-report:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Parse S3 path
        id: parse_path
        run: |
          # Parse S3 directory from input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            S3_DIR="${{ github.event.inputs.s3_directory }}"
            echo "Using manual input: $S3_DIR"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            S3_DIR="${{ github.event.client_payload.directory }}"
            echo "Using repository dispatch: $S3_DIR"
          else
            echo "Unknown trigger"
            exit 1
          fi
          
          # Remove trailing slash if present
          S3_DIR=${S3_DIR%/}
          echo "S3_DIR=$S3_DIR" >> $GITHUB_OUTPUT
          
          # Extract timestamp path for report
          TIMESTAMP_PATH=$(echo "$S3_DIR" | sed 's|^Result/consul/||')
          echo "TIMESTAMP_PATH=$TIMESTAMP_PATH" >> $GITHUB_OUTPUT
          
          # Create safe identifier
          SAFE_ID=$(echo "$TIMESTAMP_PATH" | sed 's|/|_|g' | sed 's|-|_|g')
          echo "SAFE_ID=$SAFE_ID" >> $GITHUB_OUTPUT
          
          echo "Parsed: $S3_DIR ‚Üí Report/consul/$TIMESTAMP_PATH"

      - name: Download Allure results from S3
        id: download
        run: |
          echo "Downloading from: s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/"
          mkdir -p $SOURCE_DIR
          
          # First, check what's in S3
          echo "Listing S3 contents:"
          aws s3 ls "s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/" --recursive || true
          
          # Download ALL files from the S3 directory (including subdirectories)
          echo "Downloading files..."
          aws s3 sync "s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/" $SOURCE_DIR/ --exclude "*" --include "*.xml" --include "*.json" --include "*.txt"
          
          # Check what was downloaded
          echo "Downloaded files:"
          find $SOURCE_DIR -type f | sort
          
          # Count files
          XML_COUNT=$(find $SOURCE_DIR -name "*.xml" | wc -l)
          JSON_COUNT=$(find $SOURCE_DIR -name "*.json" | wc -l)
          echo "XML_FILES=$XML_COUNT" >> $GITHUB_OUTPUT
          echo "JSON_FILES=$JSON_COUNT" >> $GITHUB_OUTPUT
          echo "Total files downloaded: $(find $SOURCE_DIR -type f | wc -l)"
          
          # If no files, try downloading everything
          if [ $XML_COUNT -eq 0 ] && [ $JSON_COUNT -eq 0 ]; then
            echo "No XML/JSON files found with filters, downloading everything..."
            aws s3 sync "s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/" $SOURCE_DIR/
          
            XML_COUNT=$(find $SOURCE_DIR -name "*.xml" | wc -l)
            JSON_COUNT=$(find $SOURCE_DIR -name "*.json" | wc -l)
            echo "After full sync - XML: $XML_COUNT, JSON: $JSON_COUNT"
          fi
          
          # Check file contents
          if [ $XML_COUNT -gt 0 ]; then
            echo "Checking first XML file structure:"
            FIRST_XML=$(find $SOURCE_DIR -name "*.xml" | head -1)
            head -20 "$FIRST_XML"
          fi

      - name: Install Java and Allure
        run: |
          # Update and install Java
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jre curl unzip
          
          # Download and install Allure
          curl -L -o allure-2.24.0.zip https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.zip
          unzip -q allure-2.24.0.zip -d /opt/
          sudo ln -sf /opt/allure-2.24.0/bin/allure /usr/local/bin/allure
          
          # Verify
          echo "Java version:"
          java -version
          echo "Allure version:"
          /opt/allure-2.24.0/bin/allure --version

      - name: Generate Allure Reports
        id: generate
        run: |
          echo "Generating Allure reports from: $SOURCE_DIR"
          
          # Clean previous reports
          rm -rf $OUTPUT_DIR $SINGLE_FILE_DIR
          mkdir -p $OUTPUT_DIR $SINGLE_FILE_DIR
          
          # Check if we have test files
          if [ ${{ steps.download.outputs.XML_FILES }} -gt 0 ] || [ ${{ steps.download.outputs.JSON_FILES }} -gt 0 ]; then
            echo "Found test files, generating reports..."
          
            # **CRITICAL FIX: Use correct Allure syntax and paths**
            # First, let's see what allure sees
            echo "Allure report list (to see what it can parse):"
            /opt/allure-2.24.0/bin/allure report list $SOURCE_DIR || echo "Allure list command failed"
          
            # Generate multi-file report
            echo "Generating multi-file report..."
            /opt/allure-2.24.0/bin/allure generate $SOURCE_DIR --output $OUTPUT_DIR --clean
          
            # Generate single-file report
            echo "Generating single-file report..."
            /opt/allure-2.24.0/bin/allure generate $SOURCE_DIR --output $SINGLE_FILE_DIR --single-file --clean
          
            # Check results
            if [ -f "$OUTPUT_DIR/index.html" ]; then
              echo "‚úÖ Multi-file report generated"
              echo "REPORT_GENERATED=true" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Multi-file report failed"
              echo "REPORT_GENERATED=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå No test files found"
            echo "REPORT_GENERATED=false" >> $GITHUB_OUTPUT
          fi
          
          # Debug: Show generated files
          echo "Generated files in $OUTPUT_DIR:"
          find $OUTPUT_DIR -type f | head -20 || echo "No files"
          
          echo "Generated files in $SINGLE_FILE_DIR:"
          find $SINGLE_FILE_DIR -type f | head -20 || echo "No files"

      - name: Fix Empty Reports - Alternative Approach
        if: steps.generate.outputs.REPORT_GENERATED == 'true'
        run: |
          # If reports are generated but empty, try a different approach
          echo "Checking if reports have content..."
          
          # Check multi-file report size
          if [ -f "$OUTPUT_DIR/index.html" ]; then
            SIZE=$(wc -c < "$OUTPUT_DIR/index.html")
            echo "Multi-file index.html size: $SIZE bytes"
          
            if [ $SIZE -lt 10000 ]; then
              echo "‚ö†Ô∏è Multi-file report seems small, trying alternative generation..."
          
              # Try with a different Allure command format
              cd $SOURCE_DIR
              /opt/allure-2.24.0/bin/allure generate . --output ../$OUTPUT_DIR --clean
              cd -
            fi
          fi
          
          # Check for single-file report
          SINGLE_FILE=$(find $SINGLE_FILE_DIR -name "*.html" | head -1)
          if [ -n "$SINGLE_FILE" ]; then
            SINGLE_SIZE=$(wc -c < "$SINGLE_FILE")
            echo "Single-file report size: $SINGLE_SIZE bytes"
          
            if [ $SINGLE_SIZE -lt 10000 ]; then
              echo "‚ö†Ô∏è Single-file report seems small..."
            fi
          fi

      - name: Upload Reports to S3
        if: steps.generate.outputs.REPORT_GENERATED == 'true'
        run: |
          REPORT_BASE_PATH="Report/consul/${{ steps.parse_path.outputs.TIMESTAMP_PATH }}"
          
          echo "Uploading to: s3://$S3_BUCKET/$REPORT_BASE_PATH/"
          
          # Clean existing reports
          aws s3 rm "s3://$S3_BUCKET/$REPORT_BASE_PATH/" --recursive --quiet || true
          
          # Upload multi-file report if it exists
          if [ -f "$OUTPUT_DIR/index.html" ]; then
            echo "Uploading multi-file report..."
            aws s3 sync "$OUTPUT_DIR/" "s3://$S3_BUCKET/$REPORT_BASE_PATH/multi-file/" --quiet
            MULTI_URL="https://k8s-nginxs3v-nginxs3g-52e35e9339-1035610716.us-east-1.elb.amazonaws.com/$REPORT_BASE_PATH/multi-file/index.html"
            echo "MULTI_URL=$MULTI_URL" >> $GITHUB_ENV
          fi
          
          # Upload single-file report
          SINGLE_FILE=$(find $SINGLE_FILE_DIR -name "*.html" | head -1)
          if [ -n "$SINGLE_FILE" ]; then
            SINGLE_NAME="allure-report-${{ steps.parse_path.outputs.SAFE_ID }}.html"
            echo "Uploading single-file as: $SINGLE_NAME"
          
            # Copy and rename
            cp "$SINGLE_FILE" "$SINGLE_FILE_DIR/$SINGLE_NAME"
            aws s3 cp "$SINGLE_FILE_DIR/$SINGLE_NAME" "s3://$S3_BUCKET/$REPORT_BASE_PATH/$SINGLE_NAME" --quiet
          
            SINGLE_URL="https://k8s-nginxs3v-nginxs3g-52e35e9339-1035610716.us-east-1.elb.amazonaws.com/$REPORT_BASE_PATH/$SINGLE_NAME"
            echo "SINGLE_URL=$SINGLE_URL" >> $GITHUB_ENV
          fi
          
          # Create a test file to verify upload
          echo "Test upload successful at $(date)" > upload-test.txt
          aws s3 cp upload-test.txt "s3://$S3_BUCKET/$REPORT_BASE_PATH/upload-test.txt"

      - name: Debug Allure Results
        if: always()
        run: |
          echo "=== DEBUG INFORMATION ==="
          echo ""
          echo "1. Source directory contents ($SOURCE_DIR):"
          ls -la $SOURCE_DIR/
          echo ""
          
          echo "2. XML files found:"
          find $SOURCE_DIR -name "*.xml" -exec echo "  - {}" \;
          echo ""
          
          echo "3. First XML file sample:"
          if [ -n "$(find $SOURCE_DIR -name '*.xml' | head -1)" ]; then
            FIRST_XML=$(find $SOURCE_DIR -name "*.xml" | head -1)
            echo "File: $FIRST_XML"
            echo "First 5 lines:"
            head -5 "$FIRST_XML"
            echo ""
            echo "Does it contain 'test-case' or 'testsuite'?"
            grep -i "test-case\|testsuite\|testcase" "$FIRST_XML" | head -3 || echo "  No test-case/testsuite tags found"
          fi
          echo ""
          
          echo "4. Allure version and capabilities:"
          /opt/allure-2.24.0/bin/allure --version
          echo ""
          
          echo "5. Try Allure validation:"
          /opt/allure-2.24.0/bin/allure validate $SOURCE_DIR || echo "Allure validation failed"

      - name: Create Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-debug-${{ steps.parse_path.outputs.SAFE_ID }}
          path: |
            $SOURCE_DIR/
            $OUTPUT_DIR/
            $SINGLE_FILE_DIR/
          retention-days: 7

      - name: Output Results
        run: |
          echo ""
          echo "========================================"
          echo "RESULTS SUMMARY"
          echo "========================================"
          echo ""
          echo "Source: ${{ steps.parse_path.outputs.S3_DIR }}"
          echo "Test files: ${{ steps.download.outputs.XML_FILES }} XML, ${{ steps.download.outputs.JSON_FILES }} JSON"
          echo ""
          
          if [ "${{ steps.generate.outputs.REPORT_GENERATED }}" = "true" ]; then
            echo "‚úÖ REPORTS GENERATED"
            echo ""
          
            if [ -n "${{ env.MULTI_URL }}" ]; then
              echo "üìä Multi-file report:"
              echo "   ${{ env.MULTI_URL }}"
            fi
          
            if [ -n "${{ env.SINGLE_URL }}" ]; then
              echo ""
              echo "üì• Single-file report:"
              echo "   ${{ env.SINGLE_URL }}"
              echo ""
              echo "Download command:"
              echo "curl -LO '${{ env.SINGLE_URL }}'"
            fi
          else
            echo "‚ùå REPORTS FAILED"
            echo ""
            echo "Check the 'Debug Allure Results' step for details."
            echo "Common issues:"
            echo "1. XML files not in Allure format"
            echo "2. Missing required XML structure"
            echo "3. Allure compatibility issue"
          fi