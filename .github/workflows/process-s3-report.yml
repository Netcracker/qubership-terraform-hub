name: Process Consul Test Results

on:
  workflow_dispatch:
    inputs:
      s3_directory:
        description: 'S3 Directory Path (e.g., Result/consul/2025-12-10/00-42-50/)'
        required: true
        default: 'Result/consul/2025-12-10/00-42-50'
        type: string
  repository_dispatch:
    types: [s3-new-consul-directory]

env:
  S3_BUCKET: qstp-consul
  OUTPUT_DIR: ./allure-report
  SINGLE_FILE_DIR: ./allure-single-file
  SOURCE_DIR: ./allure-results

jobs:
  generate-allure-report:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Parse S3 path
        id: parse_path
        run: |
          # Parse S3 directory from input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            S3_DIR="${{ github.event.inputs.s3_directory }}"
            echo "Using manual input: $S3_DIR"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            S3_DIR="${{ github.event.client_payload.directory }}"
            echo "Using repository dispatch: $S3_DIR"
          else
            echo "Unknown trigger"
            exit 1
          fi
          
          # Remove trailing slash if present
          S3_DIR=${S3_DIR%/}
          echo "S3_DIR=$S3_DIR" >> $GITHUB_OUTPUT
          
          # Extract timestamp path for report
          TIMESTAMP_PATH=$(echo "$S3_DIR" | sed 's|^Result/consul/||')
          echo "TIMESTAMP_PATH=$TIMESTAMP_PATH" >> $GITHUB_OUTPUT
          
          # Create safe identifier
          SAFE_ID=$(echo "$TIMESTAMP_PATH" | sed 's|/|_|g' | sed 's|-|_|g')
          echo "SAFE_ID=$SAFE_ID" >> $GITHUB_OUTPUT
          
          echo "Parsed: $S3_DIR ‚Üí Report/consul/$TIMESTAMP_PATH"

      - name: Download Allure results from S3
        id: download
        run: |
          echo "Downloading from: s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/"
          mkdir -p $SOURCE_DIR
          
          # First, check what's in S3
          echo "Listing S3 contents:"
          aws s3 ls "s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/" --recursive || true
          
          # Download ALL files from the S3 directory (including subdirectories)
          echo "Downloading files..."
          aws s3 sync "s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/" $SOURCE_DIR/ --exclude "*" --include "*.xml" --include "*.json" --include "*.txt"
          
          # Check what was downloaded
          echo "Downloaded files:"
          find $SOURCE_DIR -type f | sort
          
          # Count files
          XML_COUNT=$(find $SOURCE_DIR -name "*.xml" | wc -l)
          JSON_COUNT=$(find $SOURCE_DIR -name "*.json" | wc -l)
          echo "XML_FILES=$XML_COUNT" >> $GITHUB_OUTPUT
          echo "JSON_FILES=$JSON_COUNT" >> $GITHUB_OUTPUT
          echo "Total files downloaded: $(find $SOURCE_DIR -type f | wc -l)"
          
          # If no files, try downloading everything
          if [ $XML_COUNT -eq 0 ] && [ $JSON_COUNT -eq 0 ]; then
            echo "No XML/JSON files found with filters, downloading everything..."
            aws s3 sync "s3://$S3_BUCKET/${{ steps.parse_path.outputs.S3_DIR }}/" $SOURCE_DIR/
          
            XML_COUNT=$(find $SOURCE_DIR -name "*.xml" | wc -l)
            JSON_COUNT=$(find $SOURCE_DIR -name "*.json" | wc -l)
            echo "After full sync - XML: $XML_COUNT, JSON: $JSON_COUNT"
          fi
          
          # Check file contents
          if [ $XML_COUNT -gt 0 ]; then
            echo "Checking first XML file structure:"
            FIRST_XML=$(find $SOURCE_DIR -name "*.xml" | head -1)
            head -20 "$FIRST_XML"
          fi

      - name: Install Java and Allure
        run: |
          # Update and install Java
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jre curl unzip
          
          # Download and install Allure
          curl -L -o allure-2.35.1.zip https://github.com/allure-framework/allure2/releases/download/2.35.1/allure-2.35.1.zip
          unzip -q allure-2.35.1.zip -d /opt/
          sudo ln -sf /opt/allure-2.35.1/bin/allure /usr/local/bin/allure
          
          # Verify
          echo "Java version:"
          java -version
          echo "Allure version:"
          /opt/allure-2.35.1/bin/allure --version

      - name: Generate Allure Reports
        id: generate
        run: |
          echo "Generating Allure reports from: $SOURCE_DIR"
          
          # Clean previous reports
          rm -rf $OUTPUT_DIR $SINGLE_FILE_DIR
          mkdir -p $OUTPUT_DIR $SINGLE_FILE_DIR
          
          # Check if we have test files
          if [ ${{ steps.download.outputs.XML_FILES }} -gt 0 ] || [ ${{ steps.download.outputs.JSON_FILES }} -gt 0 ]; then
            echo "Found test files, generating reports..."
            pwd
            echo "Debug contents of allure-results"
            echo "$SOURCE_DIR"
            ls $SOURCE_DIR/allure-results/
          
            # Generate multi-file report
            echo "Generating multi-file report..."
            /opt/allure-2.35.1/bin/allure generate $SOURCE_DIR/allure-results/ -o $OUTPUT_DIR/ --clean
          
            echo "Generated files in $OUTPUT_DIR"
            ls $OUTPUT_DIR
          
            # Generate single-file report
            echo "Generating single-file report..."
            /opt/allure-2.35.1/bin/allure generate $SOURCE_DIR/allure-results/ -o $SINGLE_FILE_DIR --clean --single-file 
          
            echo "Generated files in $SINGLE_FILE_DIR"
            ls $SINGLE_FILE_DIR
          
            # Check results
            if [ -f "$OUTPUT_DIR/index.html" ]; then
              echo "‚úÖ Multi-file report generated"
              echo "REPORT_GENERATED=true" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Multi-file report failed"
              echo "REPORT_GENERATED=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå No test files found"
            echo "REPORT_GENERATED=false" >> $GITHUB_OUTPUT
          fi
          
          # Debug: Show generated files
          echo "Generated files in $OUTPUT_DIR:"
          find $OUTPUT_DIR -type f | head -20 || echo "No files"
          
          echo "Generated files in $SINGLE_FILE_DIR:"
          find $SINGLE_FILE_DIR -type f | head -20 || echo "No files"

      - name: Upload Reports to S3
        if: steps.generate.outputs.REPORT_GENERATED == 'true'
        run: |
          REPORT_BASE_PATH="Report/consul/${{ steps.parse_path.outputs.TIMESTAMP_PATH }}"
          
          echo "Uploading to: s3://$S3_BUCKET/$REPORT_BASE_PATH/"
          
          # Clean existing reports
          aws s3 rm "s3://$S3_BUCKET/$REPORT_BASE_PATH/" --recursive --quiet || true
          
          # Upload multi-file report if it exists
          if [ -f "$OUTPUT_DIR/index.html" ]; then
            echo "Uploading multi-file report..."
            aws s3 sync "$OUTPUT_DIR/" "s3://$S3_BUCKET/$REPORT_BASE_PATH/allure-report/" --quiet
            MULTI_URL="https://k8s-nginxs3v-nginxs3g-52e35e9339-1035610716.us-east-1.elb.amazonaws.com/$REPORT_BASE_PATH/allure-report/index.html"
            echo "MULTI_URL=$MULTI_URL" >> $GITHUB_ENV
          fi
          
          # Upload single-file report
          SINGLE_FILE=$(find $SINGLE_FILE_DIR -name "*.html" | head -1)
          if [ -n "$SINGLE_FILE" ]; then
            SINGLE_NAME="allure-report-${{ steps.parse_path.outputs.SAFE_ID }}.html"
            echo "Uploading single-file as: $SINGLE_NAME"
          
            # Copy and rename
            cp "$SINGLE_FILE" "$SINGLE_FILE_DIR/$SINGLE_NAME"
            aws s3 cp "$SINGLE_FILE_DIR/$SINGLE_NAME" "s3://$S3_BUCKET/$REPORT_BASE_PATH/$SINGLE_NAME" --quiet
            echo "DIRECT_S3_LINK=s3://$S3_BUCKET/$REPORT_BASE_PATH/" >> $GITHUB_ENV
          
            SINGLE_URL="https://k8s-nginxs3v-nginxs3g-52e35e9339-1035610716.us-east-1.elb.amazonaws.com/$REPORT_BASE_PATH/$SINGLE_NAME"
            echo "SINGLE_URL=$SINGLE_URL" >> $GITHUB_ENV
          fi
          
          # Create a test file to verify upload
          echo "Test upload successful at $(date)" > upload-test.txt
          aws s3 cp upload-test.txt "s3://$S3_BUCKET/$REPORT_BASE_PATH/upload-test.txt"

      #- name: Create Artifacts
        #if: always()
        #uses: actions/upload-artifact@v4
        #with:
         #name: allure-debug-${{ steps.parse_path.outputs.SAFE_ID }}
          #path: |
            #$SOURCE_DIR/
            #$OUTPUT_DIR/
            #$SINGLE_FILE_DIR/
          #retention-days: 7

      - name: Output Results
        run: |
          echo ""
          echo "========================================"
          echo "RESULTS SUMMARY"
          echo "========================================"
          echo ""
          echo "Source: ${{ steps.parse_path.outputs.S3_DIR }}"
          echo "Test files: ${{ steps.download.outputs.XML_FILES }} XML, ${{ steps.download.outputs.JSON_FILES }} JSON"
          echo ""
          
          if [ "${{ steps.generate.outputs.REPORT_GENERATED }}" = "true" ]; then
            echo "‚úÖ REPORTS GENERATED"
            echo ""
          
            if [ -n "${{ env.MULTI_URL }}" ]; then
              echo "üìä Multi-file report:"
              echo "   ${{ env.MULTI_URL }}"
            fi
          
            if [ -n "${{ env.SINGLE_URL }}" ]; then
              echo ""
              echo "üì• Single-file report:"
              echo "   ${{ env.SINGLE_URL }}"
              echo ""
              echo "Download command:"
              echo "curl -LO '${{ env.SINGLE_URL }}'"
            fi
          else
            echo "‚ùå REPORTS FAILED"
            echo ""
            echo "Check the 'Debug Allure Results' step for details."
            echo "Common issues:"
            echo "1. XML files not in Allure format"
            echo "2. Missing required XML structure"
            echo "3. Allure compatibility issue"
          fi

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Allure reports - ${{ github.repository }}"
          body: |
            Hello,
            
            The Allure report has been successfully generated.
            
            üìä REPORT DETAILS:
            
            üìé DOWNLOAD LINKS:
            Single report file: ${{ env.SINGLE_URL }}
            
            Multi report file:  ${{ env.MULTI_URL }}
            
            Direct link for usage win Winscp or analog viewers (need authorization):
            ${{ env.DIRECT_S3_LINK }}

            Best regards,
            DevOPS Team
          to: ${{ secrets.EMAIL_RECIPIENT_1 }}, ${{ secrets.EMAIL_RECIPIENT_2 }}
          from: "Allure Reports <${{ secrets.SMTP_USERNAME }}>"